<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Online Self-Enumeration System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the message box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* Hidden by default */
            font-size: 1rem;
            text-align: center;
        }
        .message-box.error {
            background-color: #f44336; /* Red */
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.5rem;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-100 min-h-screen flex items-center justify-center p-4">
    <div class="message-box" id="messageBox"></div>
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
        <p id="loadingMessage">Loading...</p>
    </div>

    <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-6 lg:p-10">
        <h1 class="text-3xl lg:text-4xl font-extrabold text-gray-900 mb-6 text-center">
            Create Your Account
        </h1>
        <p class="text-gray-700 text-lg mb-8 text-center">
            Register to start your self-enumeration process.
        </p>

        <form method="post" class="space-y-6" id="signupForm">
            {% csrf_token %}

            {# This is now the ONLY step #}
            <div id="step1" class="space-y-6">
                <div>
                    <label for="national_id" class="block text-sm font-medium text-gray-700">National ID</label>
                    <input type="text" name="national_id" id="national_id" placeholder="e.g., 22U/12345/PS" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="first_name" class="block text-sm font-medium text-gray-700">First Name</label>
                    <input type="text" name="first_name" id="first_name" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="last_name" class="block text-sm font-medium text-gray-700">Last Name</label>
                    <input type="text" name="last_name" id="last_name" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address (Optional)</label>
                    <input type="email" name="email" id="email" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                </div>
                <div>
                    <label for="phone_number" class="block text-sm font-medium text-gray-700">Phone Number (e.g., +256771234567)</label>
                    <input type="tel" name="phone_number" id="phone_number" placeholder="e.g., +256771234567" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" name="password" id="password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="password_confirm" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                    <input type="password" name="password_confirm" id="password_confirm" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm" required>
                </div>
                <div class="mt-8">
                    {# Changed button type and ID to directly submit signup #}
                    <button type="submit" id="signupSubmitButton" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">
                        Sign Up
                    </button>
                </div>
            </div>
        </form>

        <p class="text-center text-gray-600 text-sm mt-6">
            Already have an account? <a href="/login/" class="text-purple-600 hover:underline">Log In</a>
        </p>
    </div>

    <script>
        const signupForm = document.getElementById('signupForm');
        // Removed step1 and step2, as there's only one step now.
        // const step1 = document.getElementById('step1'); // No longer needed
        // const step2 = document.getElementById('step2'); // No longer needed

        // Updated button ID to reflect direct signup submission
        const signupSubmitButton = document.getElementById('signupSubmitButton');

        // Removed OTP and webcam related elements/variables
        // const sendOtpButton = document.getElementById('sendOtpButton'); // Removed
        // const verifyOtpAndSignupButton = document.getElementById('verifyOtpAndSignupButton'); // Removed
        // const resendOtpButton = document.getElementById('resendOtpButton'); // Removed
        // const otpTimer = document.getElementById('otpTimer'); // Removed
        // const webcamVideo = document.getElementById('webcamVideo'); // Removed
        // const captureButton = document.getElementById('captureButton'); // Removed
        // const faceCanvas = document.getElementById('faceCanvas'); // Removed
        // const capturedImage = document.getElementById('capturedImage'); // Removed
        // const faceImageDataInput = document.getElementById('faceImageData'); // Removed
        // let stream; // Removed
        // let otpCountdownInterval; // Removed
        // const OTP_EXPIRATION_SECONDS = 300; // Removed

        const nationalIdInput = document.getElementById('national_id');
        const firstNameInput = document.getElementById('first_name');
        const lastNameInput = document.getElementById('last_name');
        const emailInput = document.getElementById('email');
        const phoneNumberInput = document.getElementById('phone_number');
        const passwordInput = document.getElementById('password');
        const passwordConfirmInput = document.getElementById('password_confirm');
        // const otpCodeInput = document.getElementById('otp_code'); // Removed

        const messageBox = document.getElementById('messageBox');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');

        // Utility functions (showMessage, showLoading, hideLoading, getCookie remain)
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        function showLoading(message = 'Loading...') {
            loadingMessage.textContent = message;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (const cookie of cookies) {
                    const trimmedCookie = cookie.trim();
                    if (trimmedCookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(trimmedCookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        // Removed OTP countdown logic
        // function startOtpCountdown() { ... }

        // The form now directly submits, so the client-side validation moves here
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission initially

            const nationalId = nationalIdInput.value.trim();
            const firstName = firstNameInput.value.trim();
            const lastName = lastNameInput.value.trim();
            const email = emailInput.value.trim();
            const phoneNumber = phoneNumberInput.value.trim();
            const password = passwordInput.value;
            const passwordConfirm = passwordConfirmInput.value;

            // Basic Client-side validation before sending
            if (!nationalId || !firstName || !lastName || !phoneNumber || !password || !passwordConfirm) {
                showMessage('Please fill in all required fields.', 'error');
                return;
            }
            if (password !== passwordConfirm) {
                showMessage('Passwords do not match!', 'error');
                return;
            }
            const nationalIdRegex = /^\d{2}[A-Z]\/\d{5}\/[A-Z]{2}$/;
            if (!nationalIdRegex.test(nationalId)) {
                showMessage('National ID must be in the format: 22U/12345/PS', 'error');
                return;
            }
            const phoneRegex = /^\+?\d{9,14}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showMessage('Phone number must be in E.164 format, e.g., +256771234567.', 'error');
                return;
            }

            showLoading('Registering your account...');

            // Create a FormData object from the form to submit all fields
            const formData = new FormData(signupForm);

            try {
                // Submit the form data directly to the /signup/ URL
                const response = await fetch('/signup/', {
                    method: 'POST',
                    headers: {
                        // For FormData, 'Content-Type' is usually set automatically by the browser
                        // Do NOT set 'Content-Type': 'application/json' for FormData
                        'X-CSRFToken': csrftoken,
                    },
                    body: formData, // Send FormData directly
                });

                // Django will redirect on success, so we might not always get JSON
                if (response.redirected) {
                    window.location.href = response.url; // Follow the redirect
                } else {
                    const data = await response.json(); // Attempt to parse JSON for errors
                    hideLoading();
                    if (data.success) {
                        showMessage(data.message, 'success');
                        // No redirect if success flag is used in JSON response, which is less common for full form submission.
                        // You'll likely want a redirect in your Django view.
                    } else {
                        showMessage(data.message, 'error');
                    }
                }
            } catch (error) {
                hideLoading();
                showMessage('Network error or unexpected response. Please try again.', 'error');
                console.error('Error during signup:', error);
            }
        });

        // Removed OTP Resend Logic
        // resendOtpButton.addEventListener('click', async () => { ... });

        // Removed Webcam logic
        // function startWebcam() { ... }
        // captureButton.addEventListener('click', () => { ... });
        // window.addEventListener('beforeunload', () => { ... });
    </script>
</body>
</html>
